<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Don't use @@Identity</title>
        <meta name="viewport" content="width=device-width">

        <link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Digiguru.co.uk</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Don't use @@Identity</h2>
<p class="meta">06 Apr 2011</p>

<div class="post">
Okay, I just got burned by an @@Identity bug in SQL Server. What is that?

I had a written a spec that made it necessary for the developer to create a row in a database and return the ID to the application, then this ID would trigger an email to be sent in the site.

Suddenly it breaks, why? Check out the @@Identity anti-pattern

<span style="font-family:'Courier New';font-size:x-small;"><span style="color:blue;">CREATE</span> <span style="color:blue;">TABLE</span> <span style="color:maroon;">main</span></span>

<span style="font-family:'Courier New';font-size:x-small;"> <span style="color:maroon;">(</span>
<span style="color:maroon;">id</span> <span style="color:black;"><em>INT</em></span> <span style="color:blue;">IDENTITY</span><span style="color:maroon;">(</span><span style="color:black;">1</span><span style="color:silver;">,</span> <span style="color:black;">1</span><span style="color:maroon;">)</span><span style="color:silver;">,</span>
<span style="color:maroon;">name</span> <span style="color:black;"><em>VARCHAR</em></span><span style="color:maroon;">(</span><span style="color:black;">50</span><span style="color:maroon;">)</span>
<span style="color:maroon;">)</span>
<span style="color:blue;">CREATE</span> <span style="color:blue;">TABLE</span> <span style="color:maroon;">audit</span>
<span style="color:maroon;">(</span>
<span style="color:maroon;">id</span> <span style="color:black;"><em>INT</em></span> <span style="color:blue;">IDENTITY</span><span style="color:maroon;">(</span><span style="color:black;">1</span><span style="color:silver;">,</span> <span style="color:black;">1</span><span style="color:maroon;">)</span><span style="color:silver;">,</span>
<span style="color:maroon;">name</span> <span style="color:black;"><em>VARCHAR</em></span><span style="color:maroon;">(</span><span style="color:black;">50</span><span style="color:maroon;">)</span>
<span style="color:maroon;">)</span></span>

<span style="font-family:'Courier New';font-size:x-small;"><span style="color:blue;">INSERT</span> <span style="color:blue;">INTO</span> <span style="color:maroon;">main</span><span style="color:maroon;"> </span><span style="color:maroon;">(</span><span style="color:maroon;">name</span><span style="color:maroon;">) </span><span style="color:blue;">VALUES</span><span style="color:blue;"> </span><span style="color:maroon;">(</span><span style="color:red;">'Hello'</span><span style="color:maroon;">)</span>
<span style="color:blue;">SELECT</span> <span style="color:red;">'Number 1'</span><span style="color:silver;">,</span><span style="color:fuchsia;"><em>@@IDENTITY</em></span>
<span style="color:blue;">INSERT</span> <span style="color:blue;">INTO</span> <span style="color:maroon;">main </span><span style="color:maroon;">(</span><span style="color:maroon;">name</span><span style="color:maroon;">)</span><span style="color:maroon;"> </span><span style="color:blue;">VALUES</span><span style="color:blue;"> </span><span style="color:maroon;">(</span><span style="color:red;">'World'</span><span style="color:maroon;">)</span>
<span style="color:blue;">SELECT</span> <span style="color:red;">'Number 2'</span><span style="color:silver;">,</span><span style="color:fuchsia;"><em>@@IDENTITY</em></span>
<span style="color:blue;">GO</span></span>

Output is correctly showing "Number 1, 1", "Number 2, 2"

So a new development requires the data to be transformed for some fast access audit tables elsewhere in the site. So we put in a trigger to deal with this new requirement.

<span style="font-family:'Courier New';font-size:x-small;"><span style="color:blue;">CREATE</span> <span style="color:blue;">TRIGGER</span> <span style="color:maroon;">trig</span>
<span style="color:blue;">ON</span> <span style="color:maroon;">main</span>
<span style="color:blue;">FOR</span> <span style="color:blue;">INSERT</span>
<span style="color:blue;">AS</span>
<span style="color:blue;">INSERT</span> <span style="color:blue;">INTO</span> <span style="color:maroon;">audit</span>
<span style="color:maroon;">(</span><span style="color:maroon;">name</span><span style="color:maroon;">)</span>
<span style="color:blue;">VALUES</span> <span style="color:maroon;">(</span><span style="color:red;">'Please ignore this item'</span><span style="color:maroon;">)</span>
<span style="color:blue;">GO</span>
<span style="color:blue;">INSERT</span> <span style="color:blue;">INTO</span> <span style="color:maroon;">main</span><span style="color:maroon;"> </span><span style="color:maroon;">(</span><span style="color:maroon;">name</span><span style="color:maroon;">) </span><span style="color:blue;">VALUES</span><span style="color:blue;"> </span><span style="color:maroon;">(</span><span style="color:red;">'ID number 3'</span><span style="color:maroon;">)</span>
<span style="color:blue;">SELECT</span> <span style="color:red;">'Number 3'</span><span style="color:silver;">,</span><span style="color:silver;"> </span><span style="color:#ff00ff;"><em>@@IDENTITY</em></span></span>

Output is "Number 3, 1" - not "Number 3, 3", WHY? Well the @@Identity function returns the Last inserted Identity. Because the trigger has caused another ID to be inserted in the database before the next line is run.

<span style="font-family:'Courier New';font-size:x-small;"> <span style="color:blue;">INSERT</span> <span style="color:blue;">INTO</span> <span style="color:maroon;">main</span><span style="color:maroon;"> </span><span style="color:maroon;">(</span><span style="color:maroon;">name</span><span style="color:maroon;">)</span><span style="color:maroon;"> </span><span style="color:blue;">VALUES</span><span style="color:blue;"> </span><span style="color:maroon;">(</span><span style="color:red;">'ID number 4'</span><span style="color:maroon;">)</span>
<span style="color:blue;">SELECT</span> <span style="color:red;">'I expect ID number 4'</span><span style="color:silver;">,</span><span style="color:fuchsia;"><em>Scope_identity</em></span><span style="color:maroon;">(</span><span style="color:maroon;">)</span>
</span>

Output is "Number 4, 4". Scope_identity only includes the last identity from the scope you are running in. I fixed the rouge procedure, and then ran the excellent <a href="http://sqlcop.lessthandot.com/">SQL Cop</a> tool which is a small executable that searches your database to find common SQL issues. We had another 78 procedures in the database using the bad Identity syntax. Oh well, long evening for me, and a nice educational email to all the Devs.

You know - I cannot think of a reason when you would want to get the ID of a value outside the scope, sounds like some crazy coding if you ask me!

Now cleanup after yourself.

<span style="font-family:'Courier New';font-size:x-small;"><span style="color:blue;">DROP</span> <span style="color:blue;">TRIGGER</span> <span style="color:maroon;">trig</span>
<span style="color:blue;">DROP</span> <span style="color:blue;">TABLE</span> <span style="color:maroon;">main</span>
<span style="color:blue;">DROP</span> <span style="color:blue;">TABLE</span> <span style="color:maroon;">audit</span>
</span>

</div>


              
              
              <div id="disqus_thread"></div>
              
            <div class="footer">
              <div class="contact">
                <p>
                  Name<br />
                  What You Are<br />
                  digiguru@gmail.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/digiguru/">github.com/digiguru</a><br />
                  <a href="http://twitter.com/thedigiguru/">twitter.com/thedigiguru</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-123008-9', 'digiguru.co.uk');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');

</script>
        
<script type="text/javascript">
    var disqus_shortname = 'digigurucouk';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        
  
    </body>
</html>
