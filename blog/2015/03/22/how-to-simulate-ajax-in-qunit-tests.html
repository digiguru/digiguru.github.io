<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>How to simulate ajax in qunit tests</title>
        <meta name="viewport" content="width=device-width">

        <link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Digiguru.co.uk</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>How to simulate ajax in qunit tests</h2>
<p class="meta">22 Mar 2015</p>

<div class="post">
<p>When writing qUnit, it often gets hard trying to simulate an ajax operation.</p>

<p>Often you find yourself writing passing tests, but then breaking them when you actually have to provide the data service, or worse tightly coupling them to the actual ajax calls, or hack apart your javascript just to write tests. This doesn’t have to happen.</p>

<p>I have written a short helper to allow us to test async.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">function resolveAfter (time, args) {
    var dfd = new $.Deferred();
    window.setTimeout(function () {
        dfd.resolve(args);
    }, time || 1000);
    return dfd.promise();
}
function failAfter (time, args) {
    var dfd = new $.Deferred();
    window.setTimeout(function () {
        dfd.reject(args);
    }, time || 1000);
    return dfd.promise();
}</code></pre></div>

<p>How does it work?</p>

<p>Imagine you have a very simple bit of code that shows results from the data set</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">$.fn.examplePlugin = function() {
 
    return this.each(function() {
        
        var $this = $(this);
        $this.on(&quot;click&quot;, function() {
            Data.getData().
                then(function(d) {
                    $this.data(&quot;pass&quot;, true);
                    $this.html(d.message);
                    $this.trigger(&quot;update&quot;);
                }).
                fail(function(args) {
                    $this.data(&quot;pass&quot;, false);
                    $this.text(&quot;Could not get any data&quot;);
                    $this.trigger(&quot;update&quot;);
                });
        });
        
    });
 
};</code></pre></div>

<p>Now we should be writing qUnit tests to assert that it works in all scenarios.</p>

<p>Here are two such tests:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">//Create a mock object ready for faking the getData call
var Data = {getData: function() {}};

test(&quot;Control updates after a passed getData call&quot;, function () {
    stop();
    
    //Setup the UI.
    var $div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;).appendTo(&quot;body&quot;);
    $div.examplePlugin();
    
    //Setup the data service
    Data.getData = function() {
        return resolveAfter(10, {message: &quot;example data&quot;});
    };
    
    //Test the functionality
    $div.trigger(&quot;click&quot;);
    $div.on(&quot;update&quot;, function() {
        start();
        ok($div.data(&quot;pass&quot;), &quot;Sucessful service sets pass to true&quot;);
        equal($div.html(), &quot;example data&quot;, &quot;Data returned updates the UI&quot;);
    });
});

test(&quot;Control updates after a failed getData call&quot;, function () {
    stop();
    
    //Setup the UI.
    var $div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;).appendTo(&quot;body&quot;);
    $div.examplePlugin();
    
    //Setup the data service
    Data.getData = function() {
        return failAfter(10, {message: &quot;example data&quot;});
    };
    
    $div.trigger(&quot;click&quot;);
    $div.on(&quot;update&quot;, function() {
        start();
        ok(!$div.data(&quot;pass&quot;), &quot;Failed data set pass to false&quot;);
        equal($div.text(), &quot;Could not get any data&quot;, &quot;Failed data message&quot;);
    });
});</code></pre></div>

<p>As you can see, we can mock out data request really easily with the style of data service. You simulate an existing Data service and get reliable output so you can test every scenario. This means there is no excuse to write code for if your data services fail to return with a success message - it’s a very simple task to write code to test for the failing data service scenarios.</p>

</div>


              
              
              <div id="disqus_thread"></div>
              
            <div class="footer">
              <div class="contact">
                <p>
                  Adam Hall<br />
                  Web Developer<br />
                  digiguru@gmail.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/digiguru/">github.com/digiguru</a><br />
                  <a href="http://twitter.com/thedigiguru/">twitter.com/thedigiguru</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-123008-9', 'digiguru.co.uk');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');

</script>
        
<script type="text/javascript">
    var disqus_shortname = 'digigurucouk';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        
  
    </body>
</html>
