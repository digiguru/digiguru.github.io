<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Nice SQL pattern for when fixing data</title>
        <meta name="viewport" content="width=device-width">

        <link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Digiguru.co.uk</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Nice SQL pattern for when fixing data</h2>
<p class="meta">26 Mar 2015</p>

<div class="post">
<p>I came up with a nice straightforward pattern recently to help fix data after a lengthy database refactor.</p>

<p>Almost every release we perform has some sort of database migration, and often this will involve changing keys from one table to another, for example - occasionally we will need to change a 1 to many relationship to a many to many relationship. In other cases we are migrating data from one database to another.</p>

<p>After a release we need to monitor the data to ensure that all of the ways data gets input have been fixed. We’ve done our best to mitigate the risk, but there’s always some rouge service that hasn’t been documented making silent changes to the database on a nightly basis.</p>

<p>Here is the layout I like to use. In the example I will talk about a bunch of tables that had an Image linked to every User (Users had a column ImageID),  but we since decided to move that to a Many to Many relationship (New link table UserImages)</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql">Create Procedure Report.FaultyUserImages
As
SELECT &#39;Users with no image&#39;, * 
FROM Users
    Inner Join Images 
    On User.ImageID = Images.ImageID
    Left Outer Join UserImages
    On UserImages.UserID = Users.UserID 
        And UserImages.ImageID = Images.ImageID 
Where UserImages.ImageID Is Null</code></pre></div>

<p>This will output a report of all the missing rows from user images.</p>

<p>This is all very well, but it’s still a manual process to fix it.</p>

<p>Here is the “Improved” version which includes an optional parameter to “AutoFix”</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql">Create Procedure Report.FaultyUserImages
(@AutoFix = 0)
As
SELECT &#39;Missing data in UserImages table&#39;, * 
FROM Users
    Inner Join Images 
    On User.ImageID = Images.ImageID
    Left Outer Join UserImages
    On UserImages.UserID = Users.UserID 
        And UserImages.ImageID = Images.ImageID 
Where UserImages.ImageID Is Null

If @AutoFix = 1
Begin
    
    Insert Into UserImages
    (UserID, ImageID)
    
    SELECT UserID, ImageID 
    FROM Users
    Inner Join Images 
    On User.ImageID = Images.ImageID
    Left Outer Join UserImages
    On UserImages.UserID = Users.UserID 
        And UserImages.ImageID = Images.ImageID 
    Where UserImages.ImageID Is Null
End</code></pre></div>

<p>Run that procedure, and you still get a report of the out.</p>

<p>Run it with @AutoFix = 1 and it will fix the output.</p>

<p>After complicated releases, we create a <code>Report.Faulty...</code> procedure for every data migration, which allows us to react quickly to any corrupted data - and then fix the problem area over the course of the next sprint.</p>

</div>


              
              
              <div id="disqus_thread"></div>
              
            <div class="footer">
              <div class="contact">
                <p>
                  Adam Hall<br />
                  Web Developer<br />
                  digiguru@gmail.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/digiguru/">github.com/digiguru</a><br />
                  <a href="http://twitter.com/thedigiguru/">twitter.com/thedigiguru</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-123008-9', 'digiguru.co.uk');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');

</script>
        
<script type="text/javascript">
    var disqus_shortname = 'digigurucouk';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        
  
    </body>
</html>
