<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Writing the first calabash test</title>
        <meta name="viewport" content="width=device-width">

        <link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Digiguru.co.uk</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Writing the first calabash test</h2>
<p class="meta">10 Mar 2015</p>

<div class="post">
<p>Going through the stages of writing my first calabash test. Firstly I went to my project folder, and opened the following file <code>/features/login.feature</code>.</p>

<div class="highlight"><pre><code class="language-cucumber" data-lang="cucumber">Feature: Login
  As a bride
  I want to be able to login
  So I can plan my wedding

Scenario: Bride can login
  Given I am on the login screen
  When I type in my username
  And I type in my password
  And click login
  Then I should be logged in</code></pre></div>

<p>After running the following command in bash</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">$ cucumber</code></pre></div>

<p>I get the following output suggesting a skeleton for a new ruby file.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">Given(/^I am on the login screen$/) do
  pending # express the regexp above with the code you wish you had
end

When(/^I type in my username$/) do
  pending # express the regexp above with the code you wish you had
end

When(/^I type in my password$/) do
  pending # express the regexp above with the code you wish you had
end

When(/^click login$/) do
  pending # express the regexp above with the code you wish you had
end

Then(/^I should be logged in$/) do
  pending # express the regexp above with the code you wish you had
end</code></pre></div>

<p>I then go in to start editing, but how do you write a test? The <a href="http://developer.xamarin.com/guides/testcloud/calabash/creating-calabash-tests/">calabash documentation</a> says to run the following command:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">$ calabash-ios console</code></pre></div>

<p>This creates a new command line &lt;pre&gt;irb(main):001:0&gt;&lt;/pre&gt;, where we have to write the following:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">start_test_server_in_background</code></pre></div>

<p>That boots up the simulator. Once it’s loaded you can check for objects that you are going to run, eg…</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">query &quot;button&quot;</code></pre></div>

<p>Will show all the buttons currently available in the view in the simulator.</p>

<p>We want only the one that says skipped - and this query seems to work after a bit of trial and error.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">query &quot;button marked:&#39;walkthrough iphone btn skip&#39;&quot;</code></pre></div>

<p>It’s best to wait for the elements to appear on the device - it is unlikely that they will appear straight away. The following command will wait for an element to appear on the page…</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">wait_for(:timeout =&gt; 5) { element_exists(&quot;button marked:&#39;walkthrough iphone btn skip&#39;&quot;) }</code></pre></div>

<p>Now we need to run the test.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">cucumber</code></pre></div>

<p>SO let’s write the tests….</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">Given(/^I am on the login screen$/) do
    wait_for_elements_exist(&quot;button marked:&#39;walkthrough iphone btn skip&#39;&quot;, :timeout =&gt; 20)
    sleep(2)
    touch(&quot;button marked:&#39;walkthrough iphone btn skip&#39;&quot;)
    wait_for_elements_exist(&quot;* marked:&#39;Email Address&#39;&quot;, :timeout =&gt; 20)
    sleep(2)
end</code></pre></div>

<p>The first line skips the walk-through. I noticed that an animation occurs to reveal the page, and you need to wait an extra timeout (2 seconds) to make sure you can start clicking the UI.</p>

<p>After touching the skip button we can now wait for the login page to open, and type in the necessary data.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">When(/^I type in my username$/) do
    touch(&quot;* marked:&#39;Email Address&#39;&quot;)
    wait_for_keyboard
    keyboard_enter_text(&quot;test@email.com&quot;)    
end
When(/^I type in my password$/) do
    touch(&quot;* marked:&#39;Password&#39;&quot;)
    wait_for_keyboard
    keyboard_enter_text(&quot;password1234&quot;)
end</code></pre></div>

<p>This is fairly self-explanatory. I ran into troubles on the next line however. Initially I want the process to click the “Sing in” button. Doing this however didn’t login, it seemed to just hit another character (v). After a while I realised the keyboard was above the button, so you either need to dismiss the keyboard before doing the button click, or (as I decided was more appropriate to the user) hit return.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">When(/^click login$/) do
    keyboard_enter_char(&quot;Return&quot;)
end</code></pre></div>

<p>Now we need to make sure the user’s details get loaded. This required us to test a string with an apostrophe. The following line allows you to do that…</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">Then(/^I should be logged in$/) do
    quoted = escape_quotes(&quot;Adam&#39;s Wedding Planner&quot;)
    wait_for_elements_exist(&quot;* marked:&#39;#{quoted}&#39;&quot;, :timeout =&gt; 20)
end</code></pre></div>

<p>After running this, it works, but then when I run again, it crashes. Why? In our app the UI requires the user to read a walk-through on first load. We need to skip it on first run but then you don’t get the option again. We need to reset the simulator - otherwise you keep the state, and subsequent tests can’t complete. The following line in bash will reset the test after each run.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">$ RESET_BETWEEN_SCENARIOS=1 cucumber</code></pre></div>

<p>Now it passes every time. Nice!</p>

<p>Next I need to look at defining variables for the test and get some more complex scenarios.</p>


</div>


              
              
              <div id="disqus_thread"></div>
              
            <div class="footer">
              <div class="contact">
                <p>
                  Name<br />
                  What You Are<br />
                  digiguru@gmail.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/digiguru/">github.com/digiguru</a><br />
                  <a href="http://twitter.com/thedigiguru/">twitter.com/thedigiguru</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-123008-9', 'digiguru.co.uk');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');

</script>
        
<script type="text/javascript">
    var disqus_shortname = 'digigurucouk';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        
  
    </body>
</html>
