<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>How to refactor javascript when you have too many files</title>
        <meta name="viewport" content="width=device-width">

        <link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Digiguru.co.uk</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>How to refactor javascript when you have too many files</h2>
<p class="meta">13 Mar 2015</p>

<div class="post">
<p>You know what I hate? Having to maintain a codebase of thousands of inter-connected javascript files that have layers upon layers of dependencies. Somewhere along the line we thought “It’s good to separate concerns” - but I guess not everyone understood what “separate” means.</p>

<p>You know what I love? Refactoring.</p>

<p>Here is my step by step list of refactoring just one javascript file in a sea of interconnected files.</p>

<p>Firstly I will show an example javascript file.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">//ImageWrap.js
var imageCount = 0,
    imageList = [],
    lastId;

function addImage(id) {
    imageList.push(id);
    count++;
    lastId = id;
}

function getLastId() {
    return lastId;
}</code></pre></div>

<h1 id="add-a-closure">Add a closure</h1>

<p>It’s really hard to see in this function which functions are being used and where.</p>

<p>The very first thing I always do is wrap the whole file into a closure.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">//ImageWrap.js
(function( ImageWrap ) {

    var imageCount = 0,
        imageList = [],
        lastId;

    function addImage(id) {
        imageList.push(id);
        imageCount++;
        lastId = id;
    }

    function getLastId() {
        return lastId;
    }
    
}( window.ImageWrap = window.ImageWrap || {} ));</code></pre></div>

<p>Now if you put this through jsHint it will tell you that none of the functions are being used, and can all be removed. So either this file is not needed (unlikely) or we need to search all the other files for missing javascript variable.</p>

<h1 id="search-for-each-object-in-the-global-scope">Search for each object in the global scope</h1>

<p>Firstly, let’s move everything back into the global scope and move them in one by one.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">//ImageWrap.js

var imageCount = 0,
    imageList = [],
    lastId;

function addImage(id) {
    imageList.push(id);
    imageCount++;
    lastId = id;
}

function getLastId() {
    return lastId;
}

(function( ImageWrap ) {

}( window.ImageWrap = window.ImageWrap || {} ));</code></pre></div>

<p>You need to select each global variable and function. First is “imageCount”. This is not found in any other files, we can safely delete all references.</p>

<p>Searching for imageList gets found in another file “imageProcessing.js”…</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">function displayImages() {
    for(var i=0;i&lt;imageList.length;i++) {
        display(i);
    }
}</code></pre></div>

<p>So to “fix” this, let’s expose it as a function in the closure.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">//ImageWrap.js
var imageList = [],
    lastId;

function addImage(id) {
    imageList.push(id);
    lastId = id;
}

function getLastId() {
    return lastId;
}

(function( ImageWrap ) {
    
    ImageWrap.getImageList = function() {
        return imageList;
    }
    
}( window.ImageWrap = window.ImageWrap || {} ));

//imageProcessing.js
function displayImages() {
    for(var i=0;i&lt;ImageWrap.getImageList().length;i++) {
        display(i);
    }
}</code></pre></div>

<p>Run your pages - everything should still work. Yes - some things are still in the global scope, but we will move them when we are ready. Next, search for lastId. This too isn’t found, but getLastId() is, so do the same refactor…</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">//ImageWrap.js
var imageList = [],
    lastId;

function addImage(id) {
    imageList.push(id);
    lastId = id;
}

(function( ImageWrap ) {
    ImageWrap.getLastId = function() {
        return lastId;
    }
    ImageWrap.getImageList = function() {
        return imageList;
    }
    
}( window.ImageWrap = window.ImageWrap || {} ));</code></pre></div>

<p>Next - we search for addImage(). We discover it hidden in a click event of an html anchor tag.</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">&lt;div&gt;
    &lt;a href=&quot;javascript:void(0);&quot; onclick=&quot;addImage(1)&quot;&gt;Add first image&lt;/a&gt;
    &lt;a href=&quot;javascript:void(0);&quot; onclick=&quot;addImage(2)&quot;&gt;Add second image&lt;/a&gt;
    &lt;a href=&quot;javascript:void(0);&quot; onclick=&quot;addImage(3)&quot;&gt;Add third image&lt;/a&gt;
    &lt;a href=&quot;javascript:void(0);&quot; onclick=&quot;addImage(4)&quot;&gt;Add fourth image&lt;/a&gt;
&lt;/div&gt;</code></pre></div>

<p>We can easily clean this up… HTML needs just the data</p>

<div class="highlight"><pre><code class="language-html" data-lang="html">&lt;div class=&quot;add-image&quot;&gt;
    &lt;a href=&quot;javascript:void(0);&quot; data-id=&quot;1&quot;&gt;Add first image&lt;/a&gt;
    &lt;a href=&quot;javascript:void(0);&quot; data-id=&quot;2&quot;&gt;Add second image&lt;/a&gt;
    &lt;a href=&quot;javascript:void(0);&quot; data-id=&quot;3&quot;&gt;Add third image&lt;/a&gt;
    &lt;a href=&quot;javascript:void(0);&quot; data-id=&quot;4&quot;&gt;Add fourth image&lt;/a&gt;
&lt;/div&gt;</code></pre></div>

<p>And bind the event in the javascript…</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">//ImageWrap.js
var imageList = [],
    lastId;
    
(function( ImageWrap ) {
    $(document).ready(function() {
        $(&quot;.add-image&quot;).click(function() {
            var id = $(this).data(&quot;id&quot;);
            imageList.push(id);
            lastId = id;
        });
    });
    ImageWrap.getLastId = function() {
        return lastId;
    }
    ImageWrap.getImageList = function() {
        return imageList;
    }
    
}( window.ImageWrap = window.ImageWrap || {} ));</code></pre></div>

<p>And now everything is inside the closure, we can move the objects in.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">//ImageWrap.js
    
(function( ImageWrap ) {
    var imageList = [],
        lastId;

    $(document).ready(function() {
        $(&quot;.add-image&quot;).click(function() {
            var id = $(this).data(&quot;id&quot;);
            imageList.push(id);
            lastId = id;
        });
    });
    ImageWrap.getLastId = function() {
        return lastId;
    }
    ImageWrap.getImageList = function() {
        return imageList;
    }
}( window.ImageWrap = window.ImageWrap || {} ));</code></pre></div>

<p>Done.</p>

</div>


              
              
              <div id="disqus_thread"></div>
              
            <div class="footer">
              <div class="contact">
                <p>
                  Adam Hall<br />
                  Web Developer<br />
                  digiguru@gmail.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/digiguru/">github.com/digiguru</a><br />
                  <a href="http://twitter.com/thedigiguru/">twitter.com/thedigiguru</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-123008-9', 'digiguru.co.uk');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');

</script>
        
<script type="text/javascript">
    var disqus_shortname = 'digigurucouk';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        
  
    </body>
</html>
