<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Why you shouldn't mix your View logic with your Controller logic.</title>
        <meta name="viewport" content="width=device-width">

        <link href='http://fonts.googleapis.com/css?family=Audiowide' rel='stylesheet' type='text/css'>
        
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/">Digiguru.co.uk</a></h1>
              <a class="extra" href="/">home</a>
            </div>

                <h2>Why you shouldn't mix your View logic with your Controller logic.</h2>
<p class="meta">28 Jul 2010</p>

<div class="post">
<div class="css-full-post-content js-full-post-content">
<p>I was called up to say the admin pages for the supplier gallery had stopped working, all new images wouldn't upload. After searching through the javascript (which usually causes issues here) I discovered this juicy morsel in the code behind....</p><pre class="csharpcode"><br /><span class="kwrd">If</span> PostID = 0 <span class="kwrd">And</span> btnUpload.Text.Trim.Equals(<span class="str">"Upload Photo"</span>) <span class="kwrd">Then</span><br />  AddPostToMediaGallery()<br />  Response.Redirect(<span class="str">"MediaGallery.aspx?msg=add"</span>)<br /><span class="kwrd">Else</span><br />  UpdateMediaGalleryPost()<br />  Response.Redirect(<span class="str">"MediaGallery.aspx?msg=update"</span>)<br /><span class="kwrd">End</span> If</pre><p>That reads "If the post has no ID, and the button to upload the photo was named 'Upload Photo' then Add the photo to the media gallery, otherwise update the existing media gallery photo."</p><p>Firstly, that's too much information to read in a few lines of code, so let's refactor it a little...</p><pre class="csharpcode"><br /><br /><span class="kwrd">Public</span> <span class="kwrd">Enum</span> ImageActionType<br />  AddImage<br />  UpdateImage<br /><span class="kwrd">End</span> <span class="kwrd">Enum</span><br /><br /><span class="kwrd">Public</span> <span class="kwrd">Readonly</span> <span class="kwrd">Property</span> ActionType <span class="kwrd">As</span> ImageActionType<br />  <span class="kwrd">Get</span><br />    <span class="kwrd">If</span> PostID = 0 <span class="kwrd">And</span> btnUpload.Text.Trim.Equals(<span class="str">"Upload Photo"</span>) <span class="kwrd">Then</span><br />      <span class="kwrd">Return</span> AddImage<br />    <span class="kwrd">Else</span><br />      <span class="kwrd">Return</span> UpdateImage<br />    <span class="kwrd">End</span> <span class="kwrd">If</span><br />  <span class="kwrd">End</span> <span class="kwrd">Get</span><br /><span class="kwrd">End</span> <span class="kwrd">Property</span><br /><br />...<br /><br /><br /><span class="kwrd">If</span> ActionType = ImageActionType.AddImage <span class="kwrd">Then</span><br />  AddPostToMediaGallery()<br />  Response.Redirect(<span class="str">"MediaGallery.aspx?msg=add"</span>)<br /><span class="kwrd">Else</span><br />  UpdateMediaGalleryPost()<br />  Response.Redirect(<span class="str">"MediaGallery.aspx?msg=update"</span>)<br /><span class="kwrd">End</span> If</pre><p>There, we've moved the nasty bit of code into a much easier to read property, but the problem remains. So next I check both the properties that are in the page. PostID is 0, that's as expected... this is a new Post, so we don't have an ID. I'm confused why "0" is representing the absence of an integer. What if there was a valid post with the ID of 0? We should make PostID nullable.</p><pre class="csharpcode"><br /><span class="kwrd">Private</span> _postID <span class="kwrd">As</span> Nullable(Of <span class="kwrd">Integer</span>)<br /><span class="kwrd">Public</span> <span class="kwrd">Property</span> PostID() <span class="kwrd">As</span> Nullable(Of <span class="kwrd">Integer</span>)<br />  <span class="kwrd">Get</span><br />    <span class="kwrd">Return</span> _postID<br />  <span class="kwrd">End</span> <span class="kwrd">Get</span><br />  <span class="kwrd">Set</span>(<span class="kwrd">ByVal</span> value <span class="kwrd">As</span> Nullable(Of <span class="kwrd">Integer</span>))<br />    _postID = value<br />  <span class="kwrd">End</span> <span class="kwrd">Set</span><br /><span class="kwrd">End</span> Property</pre><p>Great, things are looking better already, but we haven't fixed the cause of the issue. Let me check the value of the buttons' text....</p><pre>Upload your Photo</pre><p>Here it is! Some designer has come in and changed the text of the button to "Upload <b>your</b> photo". That should be allowed. Why would anyone expect that changing the text of a button changes the behaviour too? I can see in the code that if the user is performing an update, it changes the label to another wording. This is the view, but the controller relies on the contents of the view to function. This is really bad. I checked all the code stubs and this is simply over-zealous programming. On no account is PostID ever set to anything but 0 for a new photo. Even if we did rely on a parameter in the page, we definitely shouldn't be storing it on the view.</p><p>So i've gone into the code and removed that condition, now it looks much nicer.</p><pre class="csharpcode"><br />    <span class="kwrd">Public</span> <span class="kwrd">ReadOnly</span> <span class="kwrd">Property</span> ActionType() <span class="kwrd">As</span> ImageActionType<br />        <span class="kwrd">Get</span><br />            <span class="kwrd">If</span> <span class="kwrd">Not</span> PostID.HasValue <span class="kwrd">Then</span><br />                <span class="kwrd">Return</span> ImageActionType.AddImage<br />            <span class="kwrd">Else</span><br />                <span class="kwrd">Return</span> ImageActionType.UpdateImage<br />            <span class="kwrd">End</span> <span class="kwrd">If</span><br />        <span class="kwrd">End</span> <span class="kwrd">Get</span><br />    <span class="kwrd">End</span> Property</pre>
</div>
</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Name<br />
                  What You Are<br />
                  digiguru@gmail.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/digiguru/">github.com/digiguru</a><br />
                  <a href="http://twitter.com/thedigiguru/">twitter.com/thedigiguru</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-123008-9', 'digiguru.co.uk');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');

</script>
    </body>
</html>
